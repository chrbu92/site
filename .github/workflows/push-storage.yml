name: Deploy Website to GCS
run-name: ${{ github.actor }} is deploying website üöÄ
on: 
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 'prod'
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - id: 'checkout'
      uses: 'actions/checkout@v4'

    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: 'projects/871402321197/locations/global/workloadIdentityPools/default-workload-pool/providers/default-workload-pool'
        service_account: 'gh-svc@planeproof-7ad94.iam.gserviceaccount.com'
        
    - id: 'upload-website'
      uses: 'google-github-actions/upload-cloud-storage@v2'
      with:
        path: '.'
        destination: 'cbulloss'
        predefinedAcl: 'publicRead'
        process_gcloudignore: true
        parent: false

    - name: 'Clean up old files'
      run: |
        TOKEN=$(gcloud auth print-access-token)
        
        # Get uploaded files (remove gs://cbulloss/ prefix)
        UPLOADED=$(echo "${{ steps.upload-website.outputs.uploaded }}" | \
                  sed 's|gs://cbulloss/||g' | tr ',' '\n' | sort)
        
        # Get all bucket files
        ALL_FILES=$(curl -s -H "Authorization: Bearer $TOKEN" \
                    "https://storage.googleapis.com/storage/v1/b/cbulloss/o" | \
                    jq -r '.items[]?.name // empty' | sort)
        
        # Delete files not in uploaded list
        filesDeleted=0
        echo "$ALL_FILES" | while read -r file; do
          if [ -n "$file" ] && ! echo "$UPLOADED" | grep -Fxq "$file"; then
            echo "Deleting old file: $file"
            curl -X DELETE -H "Authorization: Bearer $TOKEN" \
                "https://storage.googleapis.com/storage/v1/b/cbulloss/o/$(echo "$file" | jq -Rr @uri)"
            filesDeleted++
          fi
        done
        echo "‚úÖ Cleanup complete"

    - name: 'Deployment complete'
      run: |
        echo "üéâ Website deployed successfully!"
        echo "üìÅ Files uploaded: ${{ steps.upload-website.outputs.uploaded }}"